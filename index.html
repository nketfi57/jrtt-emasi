<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planning Équipe 2026</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, Arial, sans-serif; background: #f0f2f8; color: #1a1d2e; min-height: 100vh; }

.login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.login-box { background: #fff; border-radius: 16px; padding: 40px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
.login-box h1 { font-size: 1.8rem; font-weight: 800; color: #1a1d2e; margin-bottom: 8px; text-align: center; }
.login-box p { font-size: .9rem; color: #64748b; margin-bottom: 32px; text-align: center; }
.login-field { margin-bottom: 20px; }
.login-field label { display: block; font-size: .85rem; font-weight: 700; color: #475569; margin-bottom: 8px; }
.login-field input, .login-field select { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: .95rem; color: #1a1d2e; transition: border-color .2s; }
.login-field input:focus, .login-field select:focus { outline: none; border-color: #667eea; }
.login-btn { width: 100%; padding: 14px; background: #667eea; color: #fff; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background .2s; margin-top: 8px; }
.login-btn:hover { background: #5568d3; }
.login-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
.login-error, .login-info { padding: 12px; border-radius: 8px; font-size: .85rem; margin-bottom: 20px; display: none; }
.login-error { background: #fee2e2; color: #991b1b; }
.login-info { background: #dbeafe; color: #1e40af; }
.login-error.show, .login-info.show { display: block; }
.pwd-strength { margin-top: 8px; font-size: .75rem; }
.pwd-strength-bar { height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 4px; overflow: hidden; }
.pwd-strength-fill { height: 100%; width: 0%; transition: width .3s, background .3s; }
.pwd-strength-fill.weak { background: #ef4444; width: 33%; }
.pwd-strength-fill.medium { background: #eab308; width: 66%; }
.pwd-strength-fill.strong { background: #22c55e; width: 100%; }
.pwd-requirements { margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; font-size: .75rem; }
.pwd-req { display: flex; align-items: center; gap: 6px; color: #64748b; margin-bottom: 4px; }
.pwd-req.valid { color: #22c55e; }
.pwd-req::before { content: '○'; font-weight: bold; }
.pwd-req.valid::before { content: '✓'; }

header { background: #1a1d2e; color: #fff; padding: 0 28px; height: 54px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 12px rgba(0,0,0,.25); }
header h1 { font-size: 1rem; font-weight: 700; }
.header-sep { flex: 1; }
.user-badge { font-size: .75rem; padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,.1); color: #cbd5e1; font-weight: 600; }
.user-badge.admin { background: rgba(249,115,22,.2); color: #fdba74; }
.user-badge.super-admin { background: rgba(139,92,246,.3); color: #c4b5fd; }
.hbtn { display: flex; align-items: center; gap: 5px; padding: 6px 13px; border-radius: 7px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.07); color: #e2e8f0; font-size: .78rem; font-weight: 600; cursor: pointer; transition: background .15s; }
.hbtn:hover { background: rgba(255,255,255,.15); }
.hbtn.red { background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.4); color: #fca5a5; }

.layout { display: flex; height: calc(100vh - 54px); overflow: hidden; }
.sidebar { width: 200px; background: #fff; border-right: 1px solid #e2e8f0; padding: 14px; overflow-y: auto; }
.sidebar-label { font-size: .68rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; }
.type-legend { display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px; }
.type-pill { display: flex; align-items: center; gap: 7px; padding: 5px 9px; border-radius: 7px; border: 1px solid; font-size: .75rem; font-weight: 700; }
.type-pill-dot { width: 8px; height: 8px; border-radius: 2px; }

.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.toolbar { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 10px 22px; display: flex; align-items: center; gap: 10px; }
.month-title { font-size: 1rem; font-weight: 800; color: #1a1d2e; text-align: center; }
.cal-scroll { flex: 1; overflow-y: auto; padding: 18px 22px; }
.cal-wrap { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 10px rgba(0,0,0,.06); overflow: hidden; }
.cal-head-row { display: grid; grid-template-columns: 40px repeat(7, 1fr); background: #1a1d2e; }
.cal-head-cell { padding: 11px 6px; font-size: .7rem; font-weight: 800; color: rgba(255,255,255,.75); text-align: center; text-transform: uppercase; border-right: 1px solid #2d2f45; }
.cal-body { display: grid; grid-template-columns: 40px repeat(7, 1fr); }
.wnum { background: #f8fafc; border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: .62rem; color: #94a3b8; font-weight: 700; }
.dcell { border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; min-height: 84px; padding: 6px 5px; background: #fff; transition: background .12s; }
.dcell.other { background: #fafbfd; }
.dcell.wkend { background: #fcfcfe; }
.dcell.todaycell { background: #eff6ff; }
.dcell.clickable { cursor: pointer; }
.dcell.clickable:hover { background: #fef3c7; }
.dnum { font-size: .75rem; font-weight: 800; color: #475569; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 4px; }
.dcell.todaycell .dnum { background: #1a1d2e; color: #fff; }
.tags { display: flex; flex-direction: column; gap: 2px; }
.etag { font-size: .64rem; font-weight: 700; padding: 2px 5px; border-radius: 3px; border-left: 3px solid; line-height: 1.4; }

.overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 500; opacity: 0; pointer-events: none; transition: opacity .2s; }
.overlay.show { opacity: 1; pointer-events: all; }
.modal { background: #fff; border-radius: 16px; padding: 28px; width: 90vw; max-width: 520px; box-shadow: 0 24px 64px rgba(0,0,0,.25); max-height: 85vh; overflow-y: auto; }
.modal h2 { font-size: 1.05rem; font-weight: 800; margin-bottom: 6px; color: #1a1d2e; }
.modal p { font-size: .82rem; color: #64748b; margin-bottom: 18px; }
.modal-field { margin-bottom: 14px; }
.modal-field label { display: block; font-size: .72rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 6px; }
.modal-field input, .modal-field select { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: .88rem; color: #1a1d2e; background: #f8fafc; }
.modal-field input:focus, .modal-field select:focus { outline: none; border-color: #4f5edc; background: #fff; }
.modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 18px; }
.mbtn { padding: 8px 18px; border-radius: 8px; font-size: .82rem; font-weight: 700; cursor: pointer; border: 1px solid #e2e8f0; background: #f8fafc; color: #475569; transition: all .15s; }
.mbtn:hover { background: #e2e8f0; }
.mbtn.primary { background: #1a1d2e; color: #fff; border-color: #1a1d2e; }
.mbtn.danger { background: #ef4444; color: #fff; border-color: #ef4444; }
.mbtn:disabled { opacity: .45; cursor: not-allowed; }
</style>
</head>
<body>

<div class="login-page" id="loginPage">
  <div class="login-box">
    <h1>Planning Équipe 2026</h1>
    <p id="loginSubtitle">Connectez-vous pour accéder à votre planning</p>
    <div class="login-error" id="loginError">Identifiant ou mot de passe incorrect</div>
    <div class="login-info" id="loginInfo"></div>
    
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="login-field">
        <label>Identifiant</label>
        <input type="text" id="loginUsername" required autocomplete="username">
      </div>
      <div class="login-field">
        <label>Mot de passe</label>
        <input type="password" id="loginPassword" required autocomplete="current-password">
      </div>
      <button type="submit" class="login-btn">Se connecter</button>
    </form>

    <form id="changePasswordForm" onsubmit="handleChangePassword(event)" style="display:none">
      <div class="login-field">
        <label>Nouveau mot de passe</label>
        <input type="password" id="newPassword" required oninput="checkPasswordStrength()">
        <div class="pwd-strength">
          <div class="pwd-strength-bar"><div class="pwd-strength-fill" id="pwdStrengthFill"></div></div>
        </div>
        <div class="pwd-requirements">
          <div class="pwd-req" id="req-length">Au moins 8 caractères</div>
          <div class="pwd-req" id="req-uppercase">Au moins 1 majuscule</div>
          <div class="pwd-req" id="req-number">Au moins 1 chiffre</div>
        </div>
      </div>
      <div class="login-field">
        <label>Confirmer le mot de passe</label>
        <input type="password" id="confirmPassword" required>
      </div>
      <button type="submit" class="login-btn" id="changePwdBtn" disabled>Changer le mot de passe</button>
    </form>

    <form id="securityQuestionsForm" onsubmit="handleSetupSecurityQuestions(event)" style="display:none">
      <div class="login-field">
        <label>Question de sécurité 1</label>
        <select id="secQ1" required>
          <option value="">Choisir...</option>
          <option value="birth_city">Dans quelle ville êtes-vous né(e) ?</option>
          <option value="first_pet">Nom de votre premier animal ?</option>
          <option value="mother_maiden">Nom de jeune fille de votre mère ?</option>
        </select>
      </div>
      <div class="login-field">
        <label>Réponse 1</label>
        <input type="text" id="secA1" required>
      </div>
      <div class="login-field">
        <label>Question de sécurité 2</label>
        <select id="secQ2" required>
          <option value="">Choisir...</option>
          <option value="favorite_book">Votre livre préféré ?</option>
          <option value="childhood_friend">Prénom de votre meilleur ami d'enfance ?</option>
        </select>
      </div>
      <div class="login-field">
        <label>Réponse 2</label>
        <input type="text" id="secA2" required>
      </div>
      <button type="submit" class="login-btn">Enregistrer et continuer</button>
    </form>
  </div>
</div>

<div id="mainApp" style="display:none">
<header>
  <h1>Planning Équipe 2026</h1>
  <div class="user-badge" id="userBadge"></div>
  <div class="header-sep"></div>
  <button class="hbtn super-admin-only" onclick="showModal('manageTypesModal')" style="display:none">Gérer types</button>
  <button class="hbtn" onclick="showModal('changeMyPasswordModal')">Changer mot de passe</button>
  <button class="hbtn red" onclick="logout()">Déconnexion</button>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-label">Types d'absence</div>
    <div class="type-legend" id="typeLegend"></div>
  </aside>

  <div class="main">
    <div class="toolbar">
      <div class="month-title" id="monthTitle">—</div>
    </div>
    <div class="cal-scroll" id="calScroll"></div>
  </div>
</div>
</div>

<div class="overlay" id="addEventModal">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Ajouter un jour</h2>
    <p id="addEventDate"></p>
    <div class="modal-field">
      <label>Type</label>
      <select id="addEventType"></select>
    </div>
    <div class="modal-footer">
      <button class="mbtn" onclick="hideModal('addEventModal')">Annuler</button>
      <button class="mbtn primary" onclick="confirmAddEvent()">Ajouter</button>
    </div>
  </div>
</div>

<div class="overlay" id="deleteEventModal">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Supprimer un jour</h2>
    <p id="deleteEventInfo"></p>
    <div class="modal-footer">
      <button class="mbtn" onclick="hideModal('deleteEventModal')">Annuler</button>
      <button class="mbtn danger" onclick="confirmDeleteEvent()">Supprimer</button>
    </div>
  </div>
</div>

<div class="overlay" id="changeMyPasswordModal">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Changer mon mot de passe</h2>
    <form id="changeMyPasswordForm" onsubmit="handleChangeMyPassword(event)">
      <div class="modal-field">
        <label>Mot de passe actuel</label>
        <input type="password" id="currentPassword" required>
      </div>
      <div class="modal-field">
        <label>Nouveau mot de passe</label>
        <input type="password" id="myNewPassword" required oninput="checkMyPasswordStrength()">
        <div class="pwd-strength">
          <div class="pwd-strength-bar"><div class="pwd-strength-fill" id="myPwdStrengthFill"></div></div>
        </div>
        <div class="pwd-requirements">
          <div class="pwd-req" id="my-req-length">Au moins 8 caractères</div>
          <div class="pwd-req" id="my-req-uppercase">Au moins 1 majuscule</div>
          <div class="pwd-req" id="my-req-number">Au moins 1 chiffre</div>
        </div>
      </div>
      <div class="modal-field">
        <label>Confirmer</label>
        <input type="password" id="myConfirmPassword" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="mbtn" onclick="hideModal('changeMyPasswordModal')">Annuler</button>
        <button type="submit" class="mbtn primary" id="changeMyPwdBtn" disabled>Changer</button>
      </div>
    </form>
  </div>
</div>

<div class="overlay" id="manageTypesModal">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Gérer les types</h2>
    <p>Configuration des types CA, JRTT, CET</p>
    <div id="typeConfigList"></div>
    <div class="modal-footer">
      <button class="mbtn" onclick="hideModal('manageTypesModal')">Fermer</button>
    </div>
  </div>
</div>

<script>
const USERS = {
  "thierry": { password: "thierry2026", role: "super-admin", name: "PLATEROTI Thierry", personKey: "PLATEROTI", firstLogin: true },
  "vincent": { password: "vincent2026", role: "super-admin", name: "ETIEN Vincent", personKey: "ETIEN", firstLogin: true },
  "schenck": { password: "schenck2026", role: "employee", name: "SCHENCK", personKey: "SCHENCK", firstLogin: true },
  "callea": { password: "callea2026", role: "employee", name: "CALLEA", personKey: "CALLEA", firstLogin: true },
  "dautel": { password: "dautel2026", role: "employee", name: "DAUTEL", personKey: "DAUTEL", firstLogin: true },
  "grimaud": { password: "grimaud2026", role: "employee", name: "GRIMAUD", personKey: "GRIMAUD", firstLogin: true },
  "gilles": { password: "gilles2026", role: "employee", name: "GILLES", personKey: "GILLES", firstLogin: true },
  "zimmermann": { password: "zimmermann2026", role: "employee", name: "ZIMMERMANN", personKey: "ZIMMERMANN", firstLogin: true },
  "rabetge": { password: "rabetge2026", role: "employee", name: "RABETGE", personKey: "RABETGE", firstLogin: true },
  "klein": { password: "klein2026", role: "employee", name: "KLEIN", personKey: "KLEIN", firstLogin: true },
  "debs": { password: "debs2026", role: "employee", name: "DEBS", personKey: "DEBS", firstLogin: true },
  "vaubourg": { password: "vaubourg2026", role: "employee", name: "VAUBOURG", personKey: "VAUBOURG", firstLogin: true },
  "martel": { password: "martel2026", role: "employee", name: "MARTEL", personKey: "MARTEL", firstLogin: true },
  "dalmas": { password: "dalmas2026", role: "employee", name: "DALMAS", personKey: "DALMAS", firstLogin: true },
  "christophe": { password: "christophe2026", role: "employee", name: "CHRISTOPHE", personKey: "CHRISTOPHE", firstLogin: true },
  "claude": { password: "claude2026", role: "employee", name: "CLAUDE", personKey: "CLAUDE", firstLogin: true }
};

const TYPE_CONFIG = {
  "CA": { label: "Congé Annuel", color: "#ef4444", allUsersCanEdit: false },
  "JRTT": { label: "JRTT", color: "#22c55e", allUsersCanEdit: true },
  "CET": { label: "CET", color: "#eab308", allUsersCanEdit: true }
};

let currentUser = null, currentUsername = null, curYear = 2026, curMonth = 0;
let data = {
  "PLATEROTI": { id:"R457", CA:[], JRTT:[], CET:[] },
  "ETIEN": { id:"R999", CA:[], JRTT:[], CET:[] },
  "SCHENCK": { id:"R458", CA:[], JRTT:[], CET:[] },
  "CALLEA": { id:"R459", CA:[], JRTT:[], CET:[] },
  "DAUTEL": { id:"R461", CA:[], JRTT:[], CET:[] },
  "GRIMAUD": { id:"R463", CA:[], JRTT:[], CET:[] },
  "GILLES": { id:"R464", CA:[], JRTT:[], CET:[] },
  "ZIMMERMANN": { id:"R465", CA:[], JRTT:[], CET:[] },
  "RABETGE": { id:"R466", CA:[], JRTT:[], CET:[] },
  "KLEIN": { id:"R468", CA:[], JRTT:[], CET:[] },
  "DEBS": { id:"R469", CA:[], JRTT:[], CET:[] },
  "VAUBOURG": { id:"R470", CA:[], JRTT:[], CET:[] },
  "MARTEL": { id:"R471", CA:[], JRTT:[], CET:[] },
  "DALMAS": { id:"R472", CA:[], JRTT:[], CET:[] },
  "CHRISTOPHE": { id:"R473", CA:[], JRTT:[], CET:[] },
  "CLAUDE": { id:"R474", CA:[], JRTT:[], CET:[] }
};
let pendingEventDate = null, pendingDeleteEvent = null;

window.checkPasswordStrength = () => {
  const pwd = document.getElementById("newPassword").value;
  const fill = document.getElementById("pwdStrengthFill");
  const btn = document.getElementById("changePwdBtn");
  const hasLength = pwd.length >= 8, hasUpper = /[A-Z]/.test(pwd), hasNumber = /[0-9]/.test(pwd);
  document.getElementById("req-length").classList.toggle("valid", hasLength);
  document.getElementById("req-uppercase").classList.toggle("valid", hasUpper);
  document.getElementById("req-number").classList.toggle("valid", hasNumber);
  const strength = [hasLength, hasUpper, hasNumber].filter(Boolean).length;
  fill.className = "pwd-strength-fill";
  if (strength === 1) fill.classList.add("weak");
  else if (strength === 2) fill.classList.add("medium");
  else if (strength === 3) fill.classList.add("strong");
  btn.disabled = strength < 3;
};

window.checkMyPasswordStrength = () => {
  const pwd = document.getElementById("myNewPassword").value;
  const fill = document.getElementById("myPwdStrengthFill");
  const btn = document.getElementById("changeMyPwdBtn");
  const hasLength = pwd.length >= 8, hasUpper = /[A-Z]/.test(pwd), hasNumber = /[0-9]/.test(pwd);
  document.getElementById("my-req-length").classList.toggle("valid", hasLength);
  document.getElementById("my-req-uppercase").classList.toggle("valid", hasUpper);
  document.getElementById("my-req-number").classList.toggle("valid", hasNumber);
  const strength = [hasLength, hasUpper, hasNumber].filter(Boolean).length;
  fill.className = "pwd-strength-fill";
  if (strength === 1) fill.classList.add("weak");
  else if (strength === 2) fill.classList.add("medium");
  else if (strength === 3) fill.classList.add("strong");
  btn.disabled = strength < 3;
};

window.handleLogin = (e) => {
  e.preventDefault();
  const username = document.getElementById("loginUsername").value.toLowerCase().trim();
  const password = document.getElementById("loginPassword").value;
  if (USERS[username] && USERS[username].password === password) {
    currentUsername = username;
    currentUser = USERS[username];
    if (currentUser.firstLogin) {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("changePasswordForm").style.display = "block";
      document.getElementById("loginSubtitle").textContent = "Première connexion - Changement de mot de passe obligatoire";
      document.getElementById("loginInfo").textContent = "Vous devez créer votre mot de passe personnel pour continuer.";
      document.getElementById("loginInfo").classList.add("show");
    } else {
      completeLogin();
    }
  } else {
    document.getElementById("loginError").classList.add("show");
    setTimeout(() => document.getElementById("loginError").classList.remove("show"), 3000);
  }
};

window.handleChangePassword = (e) => {
  e.preventDefault();
  const newPwd = document.getElementById("newPassword").value;
  const confirmPwd = document.getElementById("confirmPassword").value;
  if (newPwd !== confirmPwd) return alert("Les mots de passe ne correspondent pas");
  USERS[currentUsername].password = newPwd;
  if (!USERS[currentUsername].securityQuestions) {
    document.getElementById("changePasswordForm").style.display = "none";
    document.getElementById("securityQuestionsForm").style.display = "block";
    document.getElementById("loginSubtitle").textContent = "Configuration des questions de sécurité";
    document.getElementById("loginInfo").textContent = "Définissez 2 questions de sécurité pour sécuriser votre compte.";
  } else {
    USERS[currentUsername].firstLogin = false;
    completeLogin();
  }
};

window.handleSetupSecurityQuestions = (e) => {
  e.preventDefault();
  const q1 = document.getElementById("secQ1").value, a1 = document.getElementById("secA1").value.toLowerCase().trim();
  const q2 = document.getElementById("secQ2").value, a2 = document.getElementById("secA2").value.toLowerCase().trim();
  if (q1 === q2) return alert("Veuillez choisir deux questions différentes");
  USERS[currentUsername].securityQuestions = [{ question: q1, answer: a1 }, { question: q2, answer: a2 }];
  USERS[currentUsername].firstLogin = false;
  completeLogin();
};

window.handleChangeMyPassword = (e) => {
  e.preventDefault();
  const currentPwd = document.getElementById("currentPassword").value;
  const newPwd = document.getElementById("myNewPassword").value;
  const confirmPwd = document.getElementById("myConfirmPassword").value;
  if (currentPwd !== USERS[currentUsername].password) return alert("Mot de passe actuel incorrect");
  if (newPwd !== confirmPwd) return alert("Les nouveaux mots de passe ne correspondent pas");
  USERS[currentUsername].password = newPwd;
  alert("Mot de passe modifié avec succès !");
  hideModal("changeMyPasswordModal");
  document.getElementById("changeMyPasswordForm").reset();
};

function completeLogin() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
  const badge = document.getElementById("userBadge");
  badge.textContent = currentUser.name;
  badge.className = currentUser.role === "super-admin" ? "user-badge super-admin" : "user-badge";
  document.querySelectorAll(".super-admin-only").forEach(el => el.style.display = currentUser.role === "super-admin" ? "" : "none");
  buildSidebar();
  render();
}

window.logout = () => {
  currentUser = null;
  currentUsername = null;
  document.getElementById("loginPage").style.display = "flex";
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("loginForm").reset();
  document.getElementById("loginForm").style.display = "block";
  document.getElementById("changePasswordForm").style.display = "none";
  document.getElementById("securityQuestionsForm").style.display = "none";
  document.getElementById("loginSubtitle").textContent = "Connectez-vous pour accéder à votre planning";
  document.getElementById("loginInfo").classList.remove("show");
};

function fmtDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function frDate(d) { return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`; }
function getWeek(d) { const dt=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=dt.getUTCDay()||7; dt.setUTCDate(dt.getUTCDate()+4-day); const y1=new Date(Date.UTC(dt.getUTCFullYear(),0,1)); return Math.ceil((((dt-y1)/86400000)+1)/7); }

function buildSidebar() {
  const leg = document.getElementById("typeLegend");
  leg.innerHTML = "";
  Object.keys(TYPE_CONFIG).forEach(typeKey => {
    const config = TYPE_CONFIG[typeKey];
    const el = document.createElement("div");
    el.className = "type-pill";
    el.style.background = `${config.color}1a`;
    el.style.color = config.color;
    el.style.borderColor = `${config.color}55`;
    el.innerHTML = `<div class="type-pill-dot" style="background:${config.color}"></div><span>${config.label}</span>`;
    leg.appendChild(el);
  });
}

function render() {
  const months = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  document.getElementById("monthTitle").textContent = `${months[curMonth]} ${curYear}`;
  const firstDay = new Date(curYear, curMonth, 1);
  const lastDay = new Date(curYear, curMonth+1, 0);
  let startDow = firstDay.getDay()-1; if(startDow<0) startDow=6;
  const totalCells = Math.ceil((startDow+lastDay.getDate())/7)*7;
  const todayStr = fmtDate(new Date());
  let html = `<div class="cal-wrap"><div class="cal-head-row"><div class="cal-head-cell"></div>`;
  ["Lu","Ma","Me","Je","Ve","Sa","Di"].forEach(d => html += `<div class="cal-head-cell">${d}</div>`);
  html += `</div><div class="cal-body">`;
  const cursor = new Date(curYear, curMonth, 1-startDow);
  for (let i=0; i<totalCells; i++) {
    if (i%7===0) html += `<div class="wnum">S${getWeek(cursor)}</div>`;
    const ds = fmtDate(cursor);
    const inM = cursor.getMonth()===curMonth && cursor.getFullYear()===curYear;
    const dow = cursor.getDay();
    const isWE = dow===0||dow===6;
    const isTod = ds===todayStr;
    const canClick = inM && currentUser && currentUser.role === "employee";
    const clickAttr = canClick ? `onclick="handleCellClick('${ds}')"` : '';
    html += `<div class="dcell${!inM?" other":""}${isWE?" wkend":""}${isTod?" todaycell":""}${canClick?" clickable":""}" ${clickAttr}>`;
    html += `<div class="dnum">${cursor.getDate()}</div><div class="tags">`;
    
    const personKey = currentUser.personKey;
    if (data[personKey]) {
      Object.keys(TYPE_CONFIG).forEach(typeKey => {
        if (data[personKey][typeKey] && data[personKey][typeKey].includes(ds)) {
          const config = TYPE_CONFIG[typeKey];
          html += `<div class="etag" style="background:${config.color}1a;color:${config.color};border-color:${config.color}">${typeKey}</div>`;
        }
      });
    }
    
    html += `</div></div>`;
    cursor.setDate(cursor.getDate()+1);
  }
  html += `</div></div>`;
  document.getElementById("calScroll").innerHTML = html;
}

function canUserEditType(typeKey) {
  if (currentUser.role === "super-admin") return true;
  if (TYPE_CONFIG[typeKey] && TYPE_CONFIG[typeKey].allUsersCanEdit) return true;
  return false;
}

window.handleCellClick = (dateStr) => {
  if (!currentUser.personKey) return;
  const personKey = currentUser.personKey;
  
  let existingType = null;
  Object.keys(TYPE_CONFIG).forEach(typeKey => {
    if (data[personKey][typeKey] && data[personKey][typeKey].includes(dateStr)) {
      existingType = typeKey;
    }
  });
  
  if (existingType) {
    if (!canUserEditType(existingType)) return alert("Vous n'avez pas la permission de modifier ce type");
    pendingDeleteEvent = { date: dateStr, type: existingType };
    document.getElementById("deleteEventInfo").textContent = `Supprimer ${existingType} le ${frDate(new Date(dateStr))} ?`;
    showModal("deleteEventModal");
  } else {
    const typeSelect = document.getElementById("addEventType");
    typeSelect.innerHTML = "";
    Object.keys(TYPE_CONFIG).forEach(typeKey => {
      if (canUserEditType(typeKey)) {
        const config = TYPE_CONFIG[typeKey];
        const option = document.createElement("option");
        option.value = typeKey;
        option.textContent = `${config.label} (${typeKey})`;
        typeSelect.appendChild(option);
      }
    });
    if (typeSelect.options.length === 0) return alert("Aucun type disponible");
    pendingEventDate = dateStr;
    document.getElementById("addEventDate").textContent = `Date : ${frDate(new Date(dateStr))}`;
    showModal("addEventModal");
  }
};

window.confirmAddEvent = () => {
  const type = document.getElementById("addEventType").value;
  const personKey = currentUser.personKey;
  if (!canUserEditType(type)) return alert("Permission refusée");
  if (!data[personKey][type]) data[personKey][type] = [];
  if (!data[personKey][type].includes(pendingEventDate)) {
    data[personKey][type].push(pendingEventDate);
    data[personKey][type].sort();
  }
  hideModal("addEventModal");
  render();
};

window.confirmDeleteEvent = () => {
  const { date, type } = pendingDeleteEvent;
  const personKey = currentUser.personKey;
  if (!canUserEditType(type)) return alert("Permission refusée");
  data[personKey][type] = data[personKey][type].filter(d => d !== date);
  hideModal("deleteEventModal");
  render();
};

window.showModal = id => document.getElementById(id).classList.add("show");
window.hideModal = id => document.getElementById(id).classList.remove("show");
document.querySelectorAll(".overlay").forEach(o => o.addEventListener("click",()=>o.classList.remove("show")));

buildSidebar();
render();
</script>
</body>
</html>
